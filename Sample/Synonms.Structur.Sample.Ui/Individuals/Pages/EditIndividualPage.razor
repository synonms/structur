@page "/individuals/{id:guid}/edit"

<PageTitle>Individual</PageTitle>

<CarbonBlazorStack FlexDirection="FlexDirection.Column" Gap="2rem">
    <CarbonBlazorPane Title="Individual">
        @if (_individual is null)
        {
            <CarbonBlazorLoadingSpinner></CarbonBlazorLoadingSpinner>
        }
        else
        {
            <CarbonBlazorForm TModel="IndividualResourceRequest" Model="@_updateIndividualRequest" CancelCallback="@OnCancelClicked" ValidationFunc="@ValidateForm" ValidSubmitCallback="@OnValidSubmitAsync">
                <CarbonBlazorTextInput Label="Reference" @bind-Value="@_individual.TenantReference" IsDisabled="true" FieldIdentifier="@FieldIdentifier.Create(() => _individual.TenantReference)"></CarbonBlazorTextInput>
                <CarbonBlazorTextInput Label="Friendly Id" @bind-Value="@_individual.FriendlyId" IsDisabled="true" FieldIdentifier="@FieldIdentifier.Create(() => _individual.FriendlyId)"></CarbonBlazorTextInput>
                <CarbonBlazorTextInput Label="Salutation" @bind-Value="@_updateIndividualRequest.Salutation" FieldIdentifier="@_salutationFieldIdentifier"></CarbonBlazorTextInput>
                <CarbonBlazorTextInput Label="Forename" @bind-Value="@_updateIndividualRequest.Forename" FieldIdentifier="@_forenameFieldIdentifier"></CarbonBlazorTextInput>
                <CarbonBlazorTextInput Label="Surname" @bind-Value="@_updateIndividualRequest.Surname" FieldIdentifier="@_surnameFieldIdentifier"></CarbonBlazorTextInput>
                
                <CarbonBlazorDataTable TModel="EmailAddressResource" Models="@_updateIndividualRequest.EmailAddresses" IsFilterEnabled="false" Title="Email Addresses">
                    <ToolbarButtons>
                        <CarbonBlazorButton Display="CarbonBlazorButtonDisplay.TextAndIcon" Icon="CarbonBlazorIcon.Add" Text="Add" OnClick="@OnAddEmailAddressClicked"></CarbonBlazorButton>
                    </ToolbarButtons>
                    <HeaderRowTemplate>
                        <CarbonBlazorDataTableHeaderCell>Address</CarbonBlazorDataTableHeaderCell>
                        <CarbonBlazorDataTableHeaderCell>Label</CarbonBlazorDataTableHeaderCell>
                        <CarbonBlazorDataTableHeaderCell>Primary?</CarbonBlazorDataTableHeaderCell>
                        <CarbonBlazorDataTableHeaderCell></CarbonBlazorDataTableHeaderCell>
                    </HeaderRowTemplate>
                    <DataRowTemplate>
                        <CarbonBlazorDataTableDataCell>
                            <CarbonBlazorTextInput @bind-Value="@context.Address" FieldIdentifier="@FieldIdentifier.Create(() => context.Address)"></CarbonBlazorTextInput>
                        </CarbonBlazorDataTableDataCell>
                        <CarbonBlazorDataTableDataCell>
                            <CarbonBlazorTextInput @bind-Value="@context.Label" FieldIdentifier="@FieldIdentifier.Create(() => context.Label)"></CarbonBlazorTextInput>
                        </CarbonBlazorDataTableDataCell>
                        <CarbonBlazorDataTableDataCell>
                            <CarbonBlazorCheckBox @bind-Value="@context.IsPrimary" FieldIdentifier="@FieldIdentifier.Create(() => context.IsPrimary)"></CarbonBlazorCheckBox>
                        </CarbonBlazorDataTableDataCell>
                        <CarbonBlazorDataTableDataCell>
                            <CarbonBlazorButtonSet Style="justify-content: end;">
                                <CarbonBlazorButton Kind="CarbonBlazorButtonKind.DangerGhost" Display="CarbonBlazorButtonDisplay.IconOnly" Icon="CarbonBlazorIcon.TrashCan" OnClick="@(() => OnDeleteEmailAddressClicked(context))"></CarbonBlazorButton>
                            </CarbonBlazorButtonSet>
                        </CarbonBlazorDataTableDataCell>
                    </DataRowTemplate>
                </CarbonBlazorDataTable>
                
                <CarbonBlazorDataTable TModel="TelephoneNumberResource" Models="@_updateIndividualRequest.TelephoneNumbers" IsFilterEnabled="false" Title="Telephone Numbers">
                    <ToolbarButtons>
                        <CarbonBlazorButton Display="CarbonBlazorButtonDisplay.TextAndIcon" Icon="CarbonBlazorIcon.Add" Text="Add" OnClick="@OnAddTelephoneNumberClicked"></CarbonBlazorButton>
                    </ToolbarButtons>
                    <HeaderRowTemplate>
                        <CarbonBlazorDataTableHeaderCell>Number</CarbonBlazorDataTableHeaderCell>
                        <CarbonBlazorDataTableHeaderCell>Label</CarbonBlazorDataTableHeaderCell>
                        <CarbonBlazorDataTableHeaderCell>Primary?</CarbonBlazorDataTableHeaderCell>
                        <CarbonBlazorDataTableHeaderCell></CarbonBlazorDataTableHeaderCell>
                    </HeaderRowTemplate>
                    <DataRowTemplate>
                        <CarbonBlazorDataTableDataCell>
                            <CarbonBlazorTextInput @bind-Value="@context.Number" FieldIdentifier="@FieldIdentifier.Create(() => context.Number)"></CarbonBlazorTextInput>
                        </CarbonBlazorDataTableDataCell>
                        <CarbonBlazorDataTableDataCell>
                            <CarbonBlazorTextInput @bind-Value="@context.Label" FieldIdentifier="@FieldIdentifier.Create(() => context.Label)"></CarbonBlazorTextInput>
                        </CarbonBlazorDataTableDataCell>
                        <CarbonBlazorDataTableDataCell>
                            <CarbonBlazorCheckBox @bind-Value="@context.IsPrimary" FieldIdentifier="@FieldIdentifier.Create(() => context.IsPrimary)"></CarbonBlazorCheckBox>
                        </CarbonBlazorDataTableDataCell>
                        <CarbonBlazorDataTableDataCell>
                            <CarbonBlazorButtonSet Style="justify-content: end;">
                                <CarbonBlazorButton Kind="CarbonBlazorButtonKind.DangerGhost" Display="CarbonBlazorButtonDisplay.IconOnly" Icon="CarbonBlazorIcon.TrashCan" OnClick="@(() => OnDeleteTelephoneNumberClicked(context))"></CarbonBlazorButton>
                            </CarbonBlazorButtonSet>
                        </CarbonBlazorDataTableDataCell>
                    </DataRowTemplate>
                </CarbonBlazorDataTable>
                
            </CarbonBlazorForm>
        }
    </CarbonBlazorPane>
</CarbonBlazorStack>

@code {
    private IndividualResource_Default? _individual;
    private IndividualResourceRequest _updateIndividualRequest = new();

    private FieldIdentifier _salutationFieldIdentifier;
    private FieldIdentifier _forenameFieldIdentifier;
    private FieldIdentifier _surnameFieldIdentifier;

    [Inject] 
    public IStructurSampleOpenApiClient StructurSampleOpenApiClient { get; set; } = null!;
    
    [Inject] 
    public INotificationBroker NotificationBroker { get; set; } = null!;

    [Inject] 
    public NavigationManager NavigationManager { get; set; } = null!;

    [Parameter] 
    public Guid Id { get; set; }
    
    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();

        _salutationFieldIdentifier = FieldIdentifier.Create(() => _updateIndividualRequest.Salutation);
        _forenameFieldIdentifier = FieldIdentifier.Create(() => _updateIndividualRequest.Forename);
        _surnameFieldIdentifier = FieldIdentifier.Create(() => _updateIndividualRequest.Surname);

        Task[] tasks =
        [
            RefreshIndividualAsync()
        ];

        await Task.WhenAll(tasks);
    }

    private async Task RefreshIndividualAsync()
    {
        try
        {
            StructurSampleApiResponse<IndividualResourceResponse_Default> response = await StructurSampleOpenApiClient.Individuals_GetByIdAsync(Id);

            _individual = response.Result.Value;

            _updateIndividualRequest = new IndividualResourceRequest
            {
                Salutation = _individual.Salutation,
                Forename = _individual.Forename,
                Surname = _individual.Surname,
                EmailAddresses = _individual.EmailAddresses.Select(x => new EmailAddressResource
                {
                    Address = x.Address,
                    IsPrimary = x.IsPrimary,
                    Label = x.Label
                }).ToList(),
                TelephoneNumbers = _individual.TelephoneNumbers.Select(x => new TelephoneNumberResource
                {
                    Number = x.Number,
                    IsPrimary = x.IsPrimary,
                    Label = x.Label
                }).ToList()
            };
        }
        catch (ApiException apiException)
        {
            Console.WriteLine($"[EXCEPTION] GetIndividual request failed ({apiException.StatusCode}): {apiException.Response}");
            NotificationBroker.Send("API Error", $"GetIndividual request failed ({apiException.StatusCode}).", CarbonBlazorNotificationStyle.LowContrast, CarbonBlazorNotificationLevel.Error);
        }
    }
    
    private IEnumerable<ValidationOutcome> ValidateForm(IndividualResourceRequest request)
    {
        List<ValidationOutcome> validationOutcomes = [];

        if (string.IsNullOrWhiteSpace(request.Forename))
        {
            validationOutcomes.Add(ValidationOutcome.Error(_forenameFieldIdentifier, "Forename must be populated"));
        }

        if (string.IsNullOrWhiteSpace(request.Surname))
        {
            validationOutcomes.Add(ValidationOutcome.Error(_surnameFieldIdentifier, "Surname must be populated"));
        }

        for (int emailIndex = 0; emailIndex < request.EmailAddresses.Count; emailIndex++)
        {
            if (string.IsNullOrWhiteSpace(request.EmailAddresses.ElementAt(emailIndex).Address) is false)
            {
                continue;
            }
            
            FieldIdentifier fieldIdentifier = FieldIdentifier.Create(() => _updateIndividualRequest.EmailAddresses.ElementAt(emailIndex).Address);
            validationOutcomes.Add(ValidationOutcome.Error(fieldIdentifier, "Email address must be populated"));
        }

        return validationOutcomes;
    }

    private void OnCancelClicked() =>
        NavigationManager.NavigateTo("individuals/" + Id);

    private async Task OnValidSubmitAsync()
    {
        try
        {
            var response = await StructurSampleOpenApiClient.Individuals_UpdateAsync(Id, _updateIndividualRequest);

            NotificationBroker.Send("Success", "Individual update request succeeded", CarbonBlazorNotificationStyle.LowContrast, CarbonBlazorNotificationLevel.Success);

            NavigationManager.NavigateTo("individuals/" + Id);
        }
        catch (ApiException apiException)
        {
            Console.WriteLine($"[EXCEPTION] UpdateIndividual request failed ({apiException.StatusCode}): {apiException.Response}");
            NotificationBroker.Send("API Error", $"UpdateIndividual request failed ({apiException.StatusCode}).", CarbonBlazorNotificationStyle.LowContrast, CarbonBlazorNotificationLevel.Error);
        }
    }

    private void OnAddEmailAddressClicked()
    {
        _updateIndividualRequest.EmailAddresses.Add(new EmailAddressResource { IsPrimary = _updateIndividualRequest.EmailAddresses.Any() is false });
    }
    
    private void OnAddTelephoneNumberClicked()
    {
        _updateIndividualRequest.TelephoneNumbers.Add(new TelephoneNumberResource { IsPrimary = _updateIndividualRequest.TelephoneNumbers.Any() is false });
    }
    
    private void OnDeleteEmailAddressClicked(EmailAddressResource emailAddress)
    {
        _updateIndividualRequest.EmailAddresses.Remove(emailAddress);
    }

    private void OnDeleteTelephoneNumberClicked(TelephoneNumberResource telephoneNumber)
    {
        _updateIndividualRequest.TelephoneNumbers.Remove(telephoneNumber);
    }
}